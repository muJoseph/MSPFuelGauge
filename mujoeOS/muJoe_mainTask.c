/*
 * muJoe_mainTask.c
 *
 *  Created on: Nov 18, 2017
 *      Author: joe
 */


////////////////////////////////////////////////////////////////////////////////////////////////
// INCLUDE
////////////////////////////////////////////////////////////////////////////////////////////////

#include "muJoe_mainTask.h"

////////////////////////////////////////////////////////////////////////////////////////////////
// STATIC FUNCTION PROTOS
////////////////////////////////////////////////////////////////////////////////////////////////

static void mainTask_getFuelProbeMeasurement( void );

////////////////////////////////////////////////////////////////////////////////////////////////
// EXTERN VAR
////////////////////////////////////////////////////////////////////////////////////////////////

////////////////////////////////////////////////////////////////////////////////////////////////
// LOCAL VAR
////////////////////////////////////////////////////////////////////////////////////////////////

static uint8    mainTask_taskId = 0;

// BEGIN DEBUG
static uint16 fuelProbeCnt = 0;
static uint8  fuelProbeSampleCnt = 0;
static bool   takeCapSenseSample = TRUE;
// END DEBUG

////////////////////////////////////////////////////////////////////////////////////////////////
// FUNCTIONS
////////////////////////////////////////////////////////////////////////////////////////////////

uint8 mainTask_getTaskId( void )
{
    return mainTask_taskId;

} // mainTask_getTaskId

void mainTask_init( uint8 taskId )
{
    mainTask_taskId = taskId;

    // Init Task Here

    // Set event for first data sample event (DEBUG)
    //taskMgr_setEvent( mainTask_taskId, MAINTASK_GET_FUEL_PROBE_MEAS_EVT );

} // mainTask_init

uint16 mainTask_evtProcessor( uint8 taskId, uint16 events )
{
    // Measure Fuel Probe Capacitance Event
    if( events & MAINTASK_GET_FUEL_PROBE_MEAS_EVT )
    {
       mainTask_getFuelProbeMeasurement();
       return (events ^ MAINTASK_GET_FUEL_PROBE_MEAS_EVT);
    }

    // Discard unknown events
    return 0;

} // mainTask_evtProcessor

////////////////////////////////////////////////////////////////////////////////////////////////
// STATIC FUNCTIONS
////////////////////////////////////////////////////////////////////////////////////////////////

static void mainTask_getFuelProbeMeasurement( void )
{
    if( takeCapSenseSample )
    {
        fuelProbeCnt = fuelProbeMgr_performMeasurement();
        fuelProbeSampleCnt++;
        putBreakPtHere();
    }
    if( taskMgr_setEventEx( mainTask_taskId, MAINTASK_GET_FUEL_PROBE_MEAS_EVT, 1000 ) != SUCCESS )
    {
        taskMgr_setEvent( mainTask_taskId, MAINTASK_GET_FUEL_PROBE_MEAS_EVT );
        takeCapSenseSample = FALSE;
    }
    else
        takeCapSenseSample = TRUE;

} // mainTask_getFuelProbeMeasurement
